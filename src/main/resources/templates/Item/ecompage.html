<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="" />
  <meta name="author" content="" />
  <title>線上商城首頁</title>
  <!-- Favicon-->
  <link rel="icon" type="image/x-icon" href="/rr/img/assets/ecom_favicon.ico" />
  <!-- Bootstrap icons-->
  <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet" />
  <!-- Core theme CSS (includes Bootstrap)-->
  <link th:href="@{/css/ecom/navItem.css}" rel="stylesheet" />
  <link th:href="@{/css/ecom/ecom_item.css}" rel="stylesheet" />
  <link th:href="@{/css/ecom/ecom_page.css}" rel="stylesheet" />
  <link rel="stylesheet" media="screen" th:href="@{/css/superfish/superfish.css}" />
  <link rel="stylesheet" media="screen" th:href="@{/css/superfish/superfish-vertical.css}" />
  <link th:href="@{/css/ecom/categoryList.css}" rel="stylesheet" />
  <link th:href="@{/css/ecom/pagination.css}" rel="stylesheet" />

  <style>
    .carousel-item {
      height: 400px;
    }

    .custom-header {
      max-width: 1200px;

      margin: 0 auto;

    }

    .sold-out-banner {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: #ffffff;
      padding: 10px;
      width: 100%;
      font-size: 20px;
      text-align: center;
      white-space: nowrap;
      z-index: 1;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
    }
  </style>
</head>

<body>
  <div th:replace="~{layout/main_navbar_ecom}"></div>


  <!-- Header banner▼-->
  <header class="custom-header bg-dark py-5">
    <div id="carouselExampleCaptions" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="0" class="active"
          aria-current="true" aria-label="Slide 1"></button>
        <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="1"
          aria-label="Slide 2"></button>
        <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="2"
          aria-label="Slide 3"></button>
      </div>
      <div class="carousel-inner">
        <div class="carousel-item active">
          <div class="imgblock" style="width: 300px; margin: 0 auto; text-align: center;">
            <img src="/rr/img/images/pretty.jpg" class="d-block w-100 h-80 " alt="...">
            <div class="carousel-caption d-none d-md-block">
              <h2>隨心所欲</h2>
              <p>做自己的主人</p>
            </div>

          </div>
        </div>
        <div class="carousel-item">
          <div class="imgblock" style="width:60%; height:100%; margin: 0 auto; text-align: center;">
            <img src="#" class="d-block w-100 h-100 object-fit-cover" alt="...">

          </div>
        </div>
        <div class="carousel-item">
          <img src="#" class="d-block w-100" alt="...">
          <div class="carousel-caption d-none d-md-block">
            <h5>Third slide label</h5>
            <p>Some representative placeholder content for the third slide.</p>
          </div>
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleCaptions"
        data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleCaptions"
        data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>
  </header>
  <!-- Header banner▲  -->


  <!-- 選單 -->
  <div class="menuContainer">
    <ul class="sf-menu sf-vertical" id="menu">
    </ul>
  </div>
  <!-- 選單 -->

  <!-- 選單選取商品 -->
  <section class="py-5">
    <div class="container px-4 px-lg-5 mt-5">
      <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
      </div>
    </div>
    <nav>
      <ul class="pagination d-flex justify-content-center flex-wrap pagination-rounded-flat pagination-success"
        id="pagination">
      </ul>
    </nav>
  </section>
  <!-- 選單選取商品 -->


  <!-- btn-to-top -->
  <a href="#" class="btn btn-to-top"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
      class="bi bi-arrow-bar-up" viewBox="0 0 16 16">
      <path fill-rule="evenodd"
        d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5zm-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5z" />
    </svg>
  </a>

  <!-- Footer-->
  <footer class="py-5 bg-dark">
    <div class="container">
      <p class="m-0 text-center text-white">Copyright &copy; 第六組 張浩輔 線上商城 2023</p>
    </div>
  </footer>
  <!-- Footer-->

  <script src="https://kit.fontawesome.com/7e347cd6cd.js" crossorigin="anonymous"></script>
  <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
  <script th:src="@{/js/ecompage.js}"></script>
  <script th:src="@{/js/jquery-3.7.0.min.js}"></script>
  <script th:src="@{/js/superfish/hoverIntent.js}"></script>
  <script th:src="@{/js/superfish/superfish.js}"></script>

  <script>
    //superFish
    jQuery(document).ready(function () {
      jQuery('ul.sf-menu').superfish({
        animation: { height: 'show' },  // slide-down effect without fade-in
        delay: 750
      });
    });

    $(document).ready(function () {
      changeCart();

      const categoryId = 'all';
      const page = 0;
      const size = 8;
      const data2 = {
        page: page,
        size: size,
        categoryId: categoryId
      };
      $.ajax({
        url: 'http://localhost:8080/rr/pageAllItems.do',
        type: 'post',
        dataType: 'json',
        data: data2,
        success: function (data) {
          console.log(data);
          const productCards = generateProductCard(data);
          $('.row-cols-2.row-cols-md-3.row-cols-xl-4.justify-content-center').html(productCards);


          //generate完成後綁定購物車事件
          bindAddToCartEvents();

          /////////////// 分頁按鈕生成///////////////////
          var totalPages = data.totalPages; // 總頁數
          var currentPage = data.number; // 目前頁數
          var pagination = $("#pagination"); // 分頁的元件

          // 清除現有的按鈕
          pagination.empty();

          // 產生新的按鈕
          for (var i = 0; i < totalPages; i++) {
            // 使用立即執行的函式表達式 (IIFE) 來捕獲每次迴圈的 i 值
            (function (i) {
              var btn = $('<li class="page-item"><a class="page-link" href="#">' + (i + 1) + '</a></li>');
              // 如果是目前的頁面，則加上active的class
              if (i == currentPage) {
                btn.addClass("active");
              }
              // 當按鈕被按下時，呼叫某個函數來取得該頁面的資料
              btn.click(function () {
                menuItemClick(categoryId, i);
              });

              pagination.append(btn);
            })(i); // 這裡傳入當前的 i 值
          }
        },

        error: function (error) {
          console.log(error);
        }
      });
    });

    //動態抓取categories選單
    let url = "http://localhost:8080/rr/categories/1";

    fetch(url)
      .then(response => response.json())
      .then(data => {
        document.getElementById('menu').innerHTML = generateMenu(data);

        const menuItems = document.querySelectorAll('a[data-category-id]');
        menuItems.forEach(item => {
          item.addEventListener('click', function (event) {
            event.preventDefault();
            const categoryId = this.getAttribute('data-category-id');
            console.log("Menu item clicked, category id: ", categoryId);
            menuItemClick(categoryId);
          });
        });

        jQuery('ul.sf-menu sf-vertical').superfish({
          animation: { height: 'show' },
          delay: 1200
        });
      })
      .catch(error => console.error('Error:', error));

    /////////////////需再加強/////////////////////
    function generateMenu(data, level = 0) {
      let menuHTML = '';
      // 添加「全部商品」選項
      if (level === 0) {
        menuHTML += `
      <li>
        <a href="#" data-category-id="all">全部商品</a>
      </li>
    `;
      }
      for (let category of data.subCategories) {
        menuHTML += `
      <li>
    `;
        ////////////////////////////////尋求更佳寫法/////////////////////////////////////
        if (level === 2) {
          menuHTML += `<a href="#" data-category-id="${category.id}">${'&nbsp;'.repeat(level * 2)}${category.name}</a>`;
        } else {
          menuHTML += `<a href="#${category.id}" data-category-id="${category.id}">${'&nbsp;'.repeat(level * 2)}${category.name}</a>`;
        }
        if (category.subCategories && category.subCategories.length > 0) {
          menuHTML += `
        <ul>
          ${generateMenu(category, level + 1)}
        </ul>
      `;
        }
        menuHTML += '</li>';
      }
      return menuHTML;
    }

    function menuItemClick(categoryId, page = 0) {
      const size = 8;

      // 如果categoryId等於'all'，則使用getItemByCategoryId.do來獲取所有商品數據
      const url = categoryId === 'all'
        ? "http://localhost:8080/rr/pageAllItems.do"
        : "http://localhost:8080/rr/getItemByCategoryId.do";

      const data1 = {
        categoryId: categoryId,
        page: page,
        size: size
      };
      console.log(JSON.stringify(data1));
      $.ajax({
        url: url,
        type: 'POST',
        //contentType: 'application/json',
        data: data1,
        success: function (data) {

          const productCards = generateProductCard(data);
          $('.row-cols-2.row-cols-md-3.row-cols-xl-4.justify-content-center').html(productCards);
          //購物車事件綁定
          bindAddToCartEvents();

          // 這裡加入分頁按鈕的生成
          var totalPages = data.totalPages; // 總頁數
          var currentPage = data.number; // 目前頁數
          var pagination = $("#pagination"); // 分頁的元件

          console.log('totalPages' + totalPages);
          console.log('currentPage' + currentPage);
          // 清除現有的按鈕
          pagination.empty();

          // 產生新的按鈕
          for (var i = 0; i < totalPages; i++) {
            console.log('測試迴圈');
            // 使用立即執行的函式表達式 (IIFE) 來捕獲每次迴圈的 i 值
            (function (i) {
              console.log('測試方法');
              var btn = $('<li class="page-item"><a class="page-link" href="#">' + (i + 1) + '</a></li>');

              // 如果是目前的頁面，則加上active的class
              if (i == currentPage) {
                btn.addClass("active");
              }

              // 當按鈕被按下時，呼叫某個函數來取得該頁面的資料
              btn.click(function () {
                menuItemClick(categoryId, i);
              });

              pagination.append(btn);
            })(i); // 這裡傳入當前的 i 值
          }

        },
        error: function (jqXHR, textStatus, errorThrown) {
          console.error('Error:', textStatus, errorThrown);
        }
      });
    }


    function generateProductCard(data) {
      console.log(data);
      let productHTML = '';

      if (data.content.length === 0) {
        productHTML = `
    <!-- '尚無商品' block -->
<div class="col mb-5">
  <div class="card h-100">
    <div class="product-grid">
      <div class="product-content text-center">
        <div class="icon" style="font-size: 3em; color: #ccc;">
          <i class="fa fa-exclamation-circle"></i>
        </div>
        <h3 class="title">尚無商品</h3>
        <p class="description">我們正在添加更多商品，請稍後再來查看。</p>
      </div>
    </div>
  </div>
</div>`;
        return productHTML;
      }

      const hasAvailableProduct = data.content.some(product => product.item.itemstatus !== '停售');

      if (!hasAvailableProduct) {
        productHTML = `
   <div class="col mb-5">
  <div class="card h-100">
    <div class="product-grid">
      <div class="product-content text-center">
        <div class="icon" style="font-size: 3em; color: #ccc;">
          <i class="fa fa-times-circle"></i>
        </div>
        <h3 class="title">所有商品都已停售</h3>
        <p class="description">我們正在更新我們的商品，請稍後再來查看。</p>
      </div>
    </div>
  </div>
</div>`;
        return productHTML;
      }

      for (let product of data.content) {
        const { item, images } = product;
        const { itemname, price, itemstatus, itemid } = item;

        if (itemstatus === '停售') {
          continue;  // 跳過停售的商品
        }

        let soldOutLabel = '';
        if (itemstatus === '售完') {
          soldOutLabel = `<div class="sold-out-banner" id="sold-out-${itemid}">售完</div>`;  // 添加售完的標籤
        }

        let img1 = "defaultPic.jpg"; // Default image
        let img2 = "defaultPic.jpg"; // Default image

        if (images.length > 0) {
          img1 = images[0].imagename;
          img2 = images.length > 1 ? images[1].imagename : img1;
        }


        const productData = `data-product='${JSON.stringify(product)}'`;

        productHTML += `
      <div class="col mb-5">
        <div class="card h-100">
          <div class="product-grid">
            <div class="product-image">
             ${soldOutLabel}  <!-- 添加售完的標籤 -->
              <a href="#" class="image">
                <img class="img-1" src="/rr/img/itemimgs/${img1}">
                <img class="img-2" src="/rr/img/itemimgs/${img2}">
              </a>
              <ul class="product-links">
                <li><a href="#"><i class="fa fa-heart"></i></a></li>
                <li><a href="#"><i class="fa fa-random"></i></a></li>
                <li><a href="#" data-product='${JSON.stringify(product)}'><i class="fa fa-shopping-cart"></i></a></li>
              </ul>
              <a href="#" class="product-view"><i class="fa fa-search"></i></a>
            </div>
            <div class="product-content">
              <ul class="rating">
                <li class="fas fa-star"></li>
                <li class="fas fa-star"></li>
                <li class="fas fa-star"></li>
                <li class="fas fa-star"></li>
                <li class="fas fa-star disable"></li>
                <li class="disable">(1 reviews)</li>
              </ul>
              <h3 class="title"><a href="#">${itemname}</a></h3>
              <div class="price">$${price.toFixed(2)}</div>
            </div>
          </div>
        </div>
      </div>
    `;
      }
      return productHTML;
    }

    //將綁定寫成方法指定於數據載入完成後綁定
    function bindAddToCartEvents() {
      changeCart();
      console.log('有綁到');
      document.querySelectorAll('a[data-product]').forEach(function (link) {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const product = JSON.parse(this.getAttribute('data-product')); // 從data-product取得數據
          console.log('storage商品' + product);
          addToCart(product); //把商品添加至購物車
          changeCart();
        });
      });
    }
    // 添加商品
    function addToCart(product) {
      let cart = localStorage.getItem('cart'); //從localStorage取得數據
      cart = cart ? JSON.parse(cart) : []; // 購物車存在?解析:空陣列
      console.log(cart);
      const index = cart.findIndex(item => item.item.itemid === product.item.itemid);
      if (index !== -1) {
        cart[index].quantity += 1;
      } else {
        cart.push({ ...product, quantity: 1 });
      }

      localStorage.setItem('cart', JSON.stringify(cart)); // 儲存至localStorage
      changeCart();
    }

    function changeCart() {
      console.log('進入改變車車');
      let cart = localStorage.getItem('cart');
      cart = cart ? JSON.parse(cart) : [];

      console.log(cart);

      let count = 0;
      for (let item of cart) {
        count += item.quantity;
      }

      document.getElementById('cart-count').textContent = count;
    }
  </script>
</body>

</html>